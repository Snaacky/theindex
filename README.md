[![Website](https://img.shields.io/website?down_message=offline&label=piracy.moe&up_message=online&url=https%3A%2F%2Fpiracy.moe&logo=data:image/png;base64,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)](https://piracy.moe)
[![GitHub Workflow Status](https://img.shields.io/github/workflow/status/ranimepiracy/index/Docker?logo=github)](https://github.com/ranimepiracy/index)
[![CodeFactor](https://www.codefactor.io/repository/github/ranimepiracy/index/badge)](https://www.codefactor.io/repository/github/ranimepiracy/index)
[![Codacy Badge](https://app.codacy.com/project/badge/Grade/841b254fc40146108ca99d32ce833199)](https://www.codacy.com/gh/ranimepiracy/index/dashboard)
[![Docker Image Size (tag)](https://img.shields.io/docker/image-size/ranimepiracy/index/latest?logo=docker)](https://hub.docker.com/r/ranimepiracy/index)
[![Subreddit subscribers](https://img.shields.io/reddit/subreddit-subscribers/animepiracy?label=%2Fr%2Fanimepiracy&logo=reddit)](https://www.reddit.com/r/animepiracy)
[![Twitter Follow](https://img.shields.io/twitter/follow/ranimepiracy?label=%40ranimepiracy&logo=twitter&style=flat)](https://twitter.com/ranimepiracy)
[![Discord](https://img.shields.io/discord/622243127435984927?label=Discord&logo=discord)](https://discord.gg/piracy)

# [piracy.moe](https://piracy.moe) index

The frontend, editor panel, and API of the /r/animepiracy index.

Please report incorrect or missing data at our [Discord server](https://discord.gg/piracy) in `#index-wiki`, not here.

## Getting started

The easiest way is to get started is by using Docker Compose. You need to copy
the [`docker-compose.yml`](docker-compose.yml) and [`example.env`](example.env) file from GitHub. Rename `example.env`
to `.env` and adjust the environment variables as you need to. with the following command:

```shell
docker-compose up -d
```

You'll need to change `<host-port>` to your port of choice. The web-server is not secured via SSL/TLS, it is in your
responsibility to put a reverse proxy in front of this container. When you run the image for the first time, don't
forget to set your own [discord-id](https://discord.com/developers/docs/resources/user) in the
env `SETUP_WHITELIST_DISCORD_ID` to be able to login and edit. Once your container has set up itself once, you can
remove the env variable from your setup.

## Database

We use [mongodb](https://github.com/mongodb/mongo) as our database server. You can deploy your own mongo setup as HA
service or just a simple single docker container via e.g.:

```shell
docker run -d \
    --name mongo \
    -v ./db:/data/db \
    mongo
```

For development or testing purposes it is highly recommended to
use [mongo-express](https://github.com/mongo-express/mongo-express) for accessing, viewing and editing the current state
of the database. If you make it publicly accessible, **don't forget** to secure it with *login credentials*.

To simply spin up a mongo-express docker container, run:

```shell
docker run -d \
    --name mongo-express \
    -p 8081:8081 \
    mongo-express
```

You can also take a look at our provided `docker-compose.yml` file on how to set it up.

## Updating container image

Warning: be aware, that we do not offer any kind of official support and every update may be with breaking changes. Be
sure to make backups before you update

To get the newest version of the container image
from [Docker Hub](https://hub.docker.com/repository/docker/ranimepiracy/index), you will need to run:

```shell
docker pull ranimepiracy/index
```

Afterwards, you will need to stop and remove your current running instance and start it again.

## Parameters

Here is a collection of the possible ENV-variables with their default values you should set in your `.env` file:

| Parameter | Function | Default |
| --- | --- | --- |
| `NEXT_PUBLIC_SITE_NAME` | The name of your site | `"The Anime Index"` |
| `NEXT_PUBLIC_DOMAIN` | Your domain or IP, remove trailing slash | `"https://piracy.moe"` |
| `NEXTAUTH_URL` | Your domain or IP, remove trailing slash | `$NEXT_PUBLIC_DOMAIN` |
| `DATABASE_URL` | Take a look at [mongodb docs](https://docs.mongodb.com/manual/reference/connection-string/) | `"mongodb://mongo:27017"` |
| `CHROME_URL` | WebSocket URL to a running chrome instance | `""ws://chrome:3300"` |
| `AUDIT_WEBHOOK` | WebHook-URL for audit-log, leave empty to disable support | `""` |
| `DISCORD_CLIENT_ID` | Discord OAuth2 client ID | `"your_discord_oauth_client_id"` |
| `DISCORD_CLIENT_SECRET` | Discord OAuth2 client secret | `"your_discord_oauth_client_secret"` |
| `DISCORD_BOT_TOKEN` | Required to access BOT resources | `"your_discord_bot_token"` |
| `SETUP_WHITELIST_DISCORD_ID=` | If you need help getting your id, check out this [guide](https://wiki.discord.id/obtain-ids/desktop) | `"your_discord_id"` |
| `MEILI_MASTER_KEY` | Set a random secure string, read more about [meili](https://docs.meilisearch.com/reference/features/authentication.html) | `"a_super_secret_long_randomly_generated_string_that_is_secure"` |

And the following env variables are only needed when you are in dev mode and debugging the db

| Parameter | Function | Default |
| --- | --- | --- |
| `ME_CONFIG_BASICAUTH_USERNAME` | [mongo-express](https://github.com/mongo-express/mongo-express) username | "admin" |
| `ME_CONFIG_BASICAUTH_PASSWORD` | [mongo-express](https://github.com/mongo-express/mongo-express) password | "SUPER_SECRET" |

## Getting started to code

### Setup around the web app

1. Getting started isn't that straight forward. You will need to have installed the latest version
   of [docker with docker-compose](https://docs.docker.com/get-docker/) on your machine.

2. Start by cloning the repo via a git client (highly recommended) or use the cli via

```shell
git clone https://github.com/ranimepiracy/index
```

3. Copy the [`example.env`](example.env) file to `.env` and insert your data. Don't forget to replace the names in the
   urls with localhost instead of e.g. mongo as you will not be running the nextJS app inside this compose stack

4. Add the following ports to the images in the [`docker-compose.yml`](docker-compose.yml) file:

| service | port-mapping |
| :---- | --- |
| `mongo` | `27017:27017` |
| `meili` | `7700:7700` |
| `chrome` | `3300:3000` |

As an example, the setup for `mongo` should look similar to this:

```yml
mongo:
  image: mongo
  container_name: index-db
  restart: unless-stopped
  ports:
    - 27017:27017
  volumes:
    - ./db:/data/db
```

5. Now run the command to start all the needed backend processes

```shell
docker-compose up -d mongo meili chrome mongo-express
```

Alternatively you can also just comment the index service and instead run the command

```shell
docker-compose up -d
```

### Web service

To start coding on the frontend, you will need to make sure, you have the latest version of
[node.js](https://nodejs.org/en/https://nodejs.org/en/) correctly installed. To install all the required dependencies
run once:

```shell
npm install
```

You should now have a folder called `node_modules`, which contains all the dependencies we need. We use
[Next.js](https://nextjs.org) as framework for our [React](https://reactjs.org) web service. To test the web service you
will have to run a db server in the background and start the frontend via:

```shell
npm run dev
```

After compiling you can open [http://localhost:3000](http://localhost:3000) in your browser of choice and see the
running web application.

As we use [Next.js](https://nextjs.org), the frontend supports hot reloading, so you can just leave the page open, while
you modify the code and see the changes on the fly in your browser.

### Docker image

To create a ready-made docker image, just run:

```shell
docker build . -t index
```

You now have a local image with tag `index` that contains a distributable version of the code which can now be run.

## Design of the web app

### ISR/SSR

Where possible we use [ISR](https://vercel.com/docs/next.js/incremental-static-regeneration) to pre generate all
publicly accessible pages for caching by CDNs or proxies while validating and fetching new data
with [SWR](https://web.dev/stale-while-revalidate/) requesting our own api.

### API

We serve every api request over the endpoint `/api`, the corresponding code can be viewed at [pages/api](pages/api).

- `/api/auth` is reserved for [NextAuth.js](https://next-auth.js.org/).
- `/api/edit/...` requires a logged-in user and usually (at least) editor rights and is for modifying or creating new
  content. The `_id` keyword `_new` is reserved for creating new content.
- `/api/delete/...` requires a logged-in user and usually (at least) editor rights and is for deleting content.
- `/api/[content]s` are public endpoints for fetching a list of all items of a certain content.
- `/api/[content]/...` are public endpoints for fetching information about a specific content.

### Page restrictions

Every page request first has to go through [_app.js](pages/_app.js), where a basic layout is being applied and if a page
has an `auth` property, it also validates whether the user can access the given page. Valid auth attributes are:

- `auth` itself is `null` or `typeof auth === "undefined"`, no restrictions. This seems to be a public page.
- `requireLogin`, not really needed, but set it for logic reasons. User must be logged-in.
- `requireAdmin`, only a user with admin rights can access this page.
- `requireEditor`, only editors can view this page.

## Contribution

Pull-requests are always welcome, but may not be always merged as it has to be in align with our idea of the index. If
you want a certain feature or have an idea, you can always open a feature request
in [Issues](https://github.com/ranimepiracy/index/issues/new?assignees=&labels=enhancement&template=feature_request.md&title=%5BFEAT%5D)
or report it on our [Discord](https://discord.gg/piracy) in `#index` to be discussed. If it is not bad, in align with
our ideas, and we find some time, we will certainly implement your requested feature (sometime...).

### Things we use

- [next.js](https://nextjs.org/) as Webserver
- [React](https://reactjs.org/) as JS framework
- Styles from [bootstrap](https://getbootstrap.com/)
- Icons from [Font Awesome](https://fontawesome.com)
- We bake everything into a [docker image](https://www.docker.com/)
- Running on [node js](https://nodejs.org/)
- User-authentication via [NextAuth.js](https://next-auth.js.org/)
- PWA-support with [next-pwa](https://www.npmjs.com/package/next-pwa)
- [mongodb](https://www.mongodb.com) as database backend
- [MeiliSearch](https://www.meilisearch.com/) as search engine
- [puppeteer](https://github.com/puppeteer/puppeteer) to create screenshots of websites
- [browserless/chrome](https://github.com/browserless/chrome) to run our chrome instance
- [react-in-viewport](https://github.com/roderickhsiao/react-in-viewport) for checking if components are visible or not
- [react-draggable](https://github.com/react-grid-layout/react-draggable) for dragging components by the end user
- [react-toastify](https://github.com/fkhadra/react-toastify) for handling notifications

And most importantly:
> The help of our awesome community :3

### Technical debts

- We use JS instead of TS (not needed, but type checking is still a wanted security feature)
- Multi-language support
- Unify `Editor`-views
- Unify db insert and updates to the format of `func(_id, dataObject)` and update only as needed, GraphQL would be
  nice...
- Move to `add`, `remove` api instead of having to send whole arrays to update lists
